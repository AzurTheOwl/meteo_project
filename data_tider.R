#TODO
#разные варианты выбора временных интервалов


#загружаем библиотеки
library(dplyr)
library(tidyr)
library(readr)
library(data.table)
library(lubridate)
library(ggplot2)
library(ggmap)
library(maps)
library(raster)

addRow <- function(data_set, final_set, iter, iter_range){
  new_row <- data.frame(data_set[iter,]$Синоптический_индекс_станции,
                        data_set[iter,]$Дата_по_Гринвичу,
                        sum(data_set[iter:(iter + iter_range),]$Сумма_осадков),
                        mean(data_set[iter:(iter + iter_range),]$Макс._темперура_воздуха_между_сроками))
  names(new_row) <- c("Синоптический_индекс_станции", "Дата_по_Гринвичу", "Сумма_осадков", "Средняя_температура")
  rbind(final_set, new_row)
}

findCondition <- function(data_set){

  output_data <- data.frame()
  i = 1
  
  while(i <= nrow(data_set)){
    if(data_set[i, "Макс._темперура_воздуха_между_сроками"] >= 0){
      i = i + 1
      next
    }
    
    timediff <- difftime(data_set[i+1, "Дата_по_Гринвичу"], data_set[i, "Дата_по_Гринвичу"], units = "hours")
    
    if(timediff > 4 | is.na(timediff)){
      if(data_set[i, "Сумма_осадков"] < 20){
        i = i + 1
        next
      }else{
        #save to out
        output_data <- addRow(data_set, output_data, i, 0)

        i = i + 1
        next
      }
    }else{
      timediff <- difftime(data_set[i+2, "Дата_по_Гринвичу"], data_set[i, "Дата_по_Гринвичу"], units = "hours")
      if(timediff > 7 | is.na(timediff)){
        if(sum(data_set[i:(i+1), "Сумма_осадков"]) < 20){
          i = i + 1
          next
        }else{
          if(data_set[i+1, "Макс._темперура_воздуха_между_сроками"] >= 0){
            if(data_set[i, "Сумма_осадков"] >= 20){
              output_data <- addRow(data_set, output_data, i, 0)
            }
            i = i + 2
            next
          }
          output_data <- addRow(data_set, output_data, i, 1)
          i = i + 2
          next
        } 
      }else{
        timediff <- difftime(data_set[i+3, "Дата_по_Гринвичу"], data_set[i, "Дата_по_Гринвичу"], units = "hours")
        if(timediff > 10 | is.na(timediff)){
          if(sum(data_set[i:(i+2), "Сумма_осадков"]) < 20){
            i=i+1
            next
          }else{
            if(data_set[i+1, "Макс._темперура_воздуха_между_сроками"] >= 0){
              if(data_set[i, "Сумма_осадков"] >= 20){
                output_data <- addRow(data_set, output_data, i, 0)
              }
              i = i + 2
              next
            }
            if(data_set[i+2, "Макс._темперура_воздуха_между_сроками"] >= 0){
              if(sum(data_set[i:(i+1), "Сумма_осадков"]) >= 20){
                output_data <- addRow(data_set, output_data, i, 1)
              }
              i = i + 3
              next
            }
            output_data <- addRow(data_set, output_data, i, 2)
            i = i + 3
            next
          } 
        }else{
          if(sum(data_set[i:(i+3), "Сумма_осадков"]) < 20){
            i = i + 1
            next
          }else{
            if(data_set[i+1, "Макс._темперура_воздуха_между_сроками"] >= 0){
              if(data_set[i, "Сумма_осадков"] >= 20){
                output_data <- addRow(data_set, output_data, i, 0)
              }
              i = i + 2
              next
            }
            if(data_set[i+2, "Макс._темперура_воздуха_между_сроками"] >= 0){
              if(sum(data_set[i:(i+1), "Сумма_осадков"]) >= 20){
                output_data <- addRow(data_set, output_data, i, 1)
              }
              i = i + 3
              next
            }
            if(data_set[i+3, "Макс._темперура_воздуха_между_сроками"] >= 0){
              if(sum(data_set[i:(i+2), "Сумма_осадков"]) >= 20){
                output_data <- addRow(data_set, output_data, i, 2)
              }
              i = i + 4
              next
            }
            output_data <- addRow(data_set, output_data, i, 3)
            i = i + 4
            next
          } 
        }
      }
    }
  }
  return(output_data)
}

setwd("C:/Users/User/Desktop/Meteo")#устанавливаем рабочую директорию

#читаем имена колонок
columns <- scan('colnames.txt',
                what = character(),
                encoding = 'UTF-8')

columns <- gsub('[_]$', '', columns)


#читаем инфо о метеостанции
stations <- readr::read_delim('meteo_stations.csv',
                       delim = ';',
                       col_names = c(columns[1], 'Локация', 'Широта', 'СЮ', 'Долгота', 'ЗВ', 'Подъем'),
                       trim_ws = T) %>%
            #форматируем координаты
            mutate(Широта = case_when(СЮ == 'ю.ш.' ~ -Широта, TRUE ~ Широта)) %>%
            mutate(Долгота = case_when(ЗВ == 'з.д.' ~ -Долгота, TRUE ~ Долгота)) %>%
            dplyr::select(-СЮ, -ЗВ)


final_data <- data.frame()

#читаем список файлов
files <- list.files(path="data/", pattern="*.txt", full.names=T, recursive=FALSE)

#подготавливаем файлы данных
for (file_num in 1:length(files)) {
  #читаем данные с метеостанции
  data_buff <- fread(files[file_num], header = F,
                    stringsAsFactors = F,
                    nrows = -1,
                    select = c(1:5, 48, 69),
                    col.names = columns[c(1:5, 48, 69)],
                    blank.lines.skip = T,
                    fill = T,
                    strip.white = T,
                    na.strings = c("NA", "N/A", "null" ),
                    colClasses = list(character=1:90)) %>%
    mutate(Синоптический_индекс_станции = as.integer(Синоптический_индекс_станции),
            Год___по_Гринвичу = as.integer(Год___по_Гринвичу),
            Месяц_по_Гринвичу = as.integer(Месяц_по_Гринвичу),
            День__по_Гринвичу = as.integer(День__по_Гринвичу),
            Срок__по_Гринвичу = as.integer(Срок__по_Гринвичу),
            Сумма_осадков = as.numeric(Сумма_осадков),
            Макс._темперура_воздуха_между_сроками = as.numeric(Макс._темперура_воздуха_между_сроками)) %>%
    #убираем строки с NA
    na.omit() %>%
    #форматируем время
    unite(Дата_по_Гринвичу, Год___по_Гринвичу, Месяц_по_Гринвичу, День__по_Гринвичу, Срок__по_Гринвичу, sep = "_")%>%
    mutate(Дата_по_Гринвичу = ymd_h(Дата_по_Гринвичу)) %>%

    findCondition()
  final_data <- rbind(final_data, data_buff)
}

write_excel_csv(final_data, "final_data.csv")

results <- inner_join(final_data, stations, by = 'Синоптический_индекс_станции') %>% 
  dplyr::select(Синоптический_индекс_станции, Локация, Широта, Долгота, Подъем, Дата_по_Гринвичу, Сумма_осадков, Средняя_температура)

write_excel_csv(results, "results.csv")

# #создаем финальную таблицу
# final_data_set <- bind_rows(target_data)
# #подсчитываем количество упоминаний станции в таблице
# counts <- count(final_data_set, Локация)
# #добавляем число упоминаний отдельным столбцом и сортируем по возрастанию осадков
# final_data_set <- inner_join(final_data_set, counts[, c(2,3)], by ="Локация") %>%
#   #ungroup() %>%
#   #mutate(colorscalerate = (Сумма_осадков-min(Сумма_осадков))/(max(Сумма_осадков)-min(Сумма_осадков))) %>%
#   #group_by(Синоптический_индекс_станции, Начало_периода) %>%
#   arrange(Сумма_осадков)

results_for_graphs <- filter(results, Сумма_осадков < 75, Средняя_температура > -35)

#строим график температура/осадки
results_for_graphs %>%
  ggplot(aes(x = Средняя_температура, y = Сумма_осадков)) +
  geom_point() +
  theme_light() +
  labs(title = "Осадки-температура", x = "Средняя температура", y = "Сумма осадков")
  #facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура.png")

results_for_graphs %>%
  ggplot(aes(x = Дата_по_Гринвичу)) +
  geom_point(aes(y = Сумма_осадков, colour = "Осадки")) +
  geom_point(aes(y = Средняя_температура + 75, colour = "Температура")) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~.-75, name = "Средняя температура")) +
  theme_light() +
  labs(title = "Осадки-температура-время", x = "Год", y = "Сумма осадков", colour = "Параметр") +
  theme(legend.position = "top")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура-время.png")

results_for_graphs %>%
  ggplot(aes(x = Дата_по_Гринвичу)) +
  stat_bin_2d(aes(y = Сумма_осадков, colour = "Осадки"), bins = 20) +
  stat_bin_2d(aes(y = Средняя_температура+75, colour = "Температура"), bins = 20) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~.-75, name = "Средняя температура")) +
  theme_light() +
  labs(title = "Осадки-температура-время", x = "Год", y = "Сумма осадков", colour = "Параметр") +
  theme(legend.position = "top")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура-время плотность.png")

results_for_graphs %>%
  ggplot(aes(x = Средняя_температура, y = Сумма_осадков)) +
  stat_density2d(aes(fill = ..level..), geom = "polygon", n = 100, contour = T) +
  theme_light() +
  labs(title = "Осадки-температура", x = "Средняя температура", y = "Сумма осадков")
  #facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура уровни цвет.png")

results_for_graphs %>%
  ggplot(aes(x = Средняя_температура, y = Сумма_осадков)) +
  stat_bin2d(aes(fill = ..density..), bins = 15) +
  theme_light() +
  labs(title = "Осадки-температура", x = "Средняя температура", y = "Сумма осадков")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура уровни.png")

results_for_graphs %>%
  ggplot(aes(x = Средняя_температура, y = Сумма_осадков, z = Дата_по_Гринвичу)) +
  stat_summary_hex() +
  theme_light() +
  labs(title = "Осадки-температура", x = "Средняя температура", y = "Сумма осадков")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-температура гексы.png")

results_for_graphs %>%
  ggplot(aes(x = Дата_по_Гринвичу, y = Сумма_осадков)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light() +
  scale_x_datetime() + 
  scale_y_continuous(trans = "log") +
  labs(title = "Осадки-время", x = "Год", y = "Сумма осадков")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-время.png")

results_for_graphs %>%
  mutate(Дата_по_Гринвичу = floor_date(Дата_по_Гринвичу, years(5))) %>%
  # mutate(Дата_по_гринвичу = round(as.numeric(Дата_по_Гринвичу)/5)*5) %>%
  # mutate(Дата_по_Гринвичу = factor(Дата_по_Гринвичу)) %>%
  ggplot(aes(x = Дата_по_Гринвичу, y = Сумма_осадков)) +
  geom_boxplot(aes(group = Дата_по_Гринвичу)) +
  geom_smooth(method = "lm") +
  #geom_line(aes(group = Сумма_осадков), colour = "blue") +
  theme_light() +
  # scale_x_datetime() + 
  scale_y_continuous(trans = "log10") +
  labs(title = "Осадки-время", x = "Год", y = "Сумма осадков")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-время box.png")

library(scales)

reverselog_trans <- function(base = exp(1)) {
  trans <- function(x) -log(x, base)
  inv <- function(x) base^(-x)
  trans_new(paste0("reverselog-", format(base)), trans, inv, 
            log_breaks(base = base), 
            domain = c(1e-100, Inf))
}

results_for_graphs %>%
  ggplot(aes(x = Дата_по_Гринвичу, y = -Средняя_температура)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light() +
  scale_y_continuous(trans=reverselog_trans(base=2), 
                     labels=trans_format("identity", function(x) -x)) +
  # scale_y_continuous(trans = "log2") +
  # scale_y_continuous(trans = "reverse") +
  labs(title = "Температура-время", x = "Год", y = "Средняя температура за событие")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Температура-время.png")

results_for_graphs %>%
  mutate(Дата_по_Гринвичу = floor_date(Дата_по_Гринвичу, years(5))) %>%
  ggplot(aes(x = Дата_по_Гринвичу, y = -Средняя_температура)) +
  geom_boxplot(aes(group = Дата_по_Гринвичу)) +
  geom_smooth(method = "lm") +
  theme_light() +
  scale_y_continuous(trans=reverselog_trans(base=2), 
                     labels=trans_format("identity", function(x) -x)) +
  # scale_y_continuous(trans = "log2") +
  # scale_y_continuous(trans = "reverse") +
  labs(title = "Температура-время", x = "Год", y = "Средняя температура за событие")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Температура-время box.png")

results_by_year <- mutate(results_for_graphs, Дата_по_Гринвичу = year(Дата_по_Гринвичу))

results_by_year %>%
  ggplot(aes(x = Дата_по_Гринвичу, y = Сумма_осадков)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("Осадки-годы.png")

results_by_year %>%
  ggplot(aes(Дата_по_Гринвичу)) +
  stat_bin(aes(fill = -..density..), binwidth = 5, center = 2.5) +
  theme_light() +
  labs(title = "Снегопады-годы", x = "Год", y = "Число событий") #+
  #coord_cartesian(xlim = c(1974, 2016))
  # xlim(1974, 2016) +
  # scale_x_continuous(limits = c(1974, 2016))

  #scale_fill_brewer(palette = "Blues") 
  #geom_histogram(binwidth = 5)
  #geom_bar() #+
  #geom_smooth(method = "lm")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("События-годы.png")



results_by_month <- results_for_graphs %>%
  mutate(Дата_по_Гринвичу = month(Дата_по_Гринвичу))

results_by_month %>%
  ggplot(aes(Дата_по_Гринвичу)) +
  stat_bin(aes(fill = -..density..), binwidth = 1, center = 2.5) +
  theme_light() +
  scale_x_discrete(labels = month.abb) +
  labs(title = "Снегопады-месяцы", x = "Месяц", y = "Число событий")
#coord_cartesian(xlim = c(1974, 2016))
# xlim(1974, 2016) +
# scale_x_continuous(limits = c(1974, 2016))

#scale_fill_brewer(palette = "Blues") 
#geom_histogram(binwidth = 5)
#geom_bar() #+
#geom_smooth(method = "lm")
#facet_grid(Синоптический_индекс_станции ~ Начало_периода)
ggsave("События-сезоны.png")



#загружаем карту России
russia <- getData("GADM", country= "RUS", level=1)
russia <- fortify(russia)
#делаем смещение для корректного отображения карты
russia = within(russia, {long = ifelse(long < 0, long + 360, long)})
results_by_year_map = within(results_by_year, {Долгота = ifelse(Долгота < 0, Долгота + 360, Долгота)})

#строим карту с расположением метеостанций
locations_plot <- ggplot() +
  geom_map(data= russia, map= russia, aes(x=long,y=lat, map_id=id,group=group), fill="white", colour="black") +
  geom_point(data = results_by_year_map, aes(x = Долгота, y = Широта, color = Локация), size = 2) +
  scale_size(range=c(2,7)) +
  labs(title= "Расположение метеостанций", x="Longitude", y= "Latitude") +
  theme(legend.position="none") +
  coord_map(projection = "azequidistant")
#сохраняем карту
ggsave("Расположение метеостанций.png")
#отображаем карту (можно закомментировать)
locations_plot

#строим карту с отображением частоты осадков
precipitation_freq_plot <- ggplot() +
  geom_map(data= russia, map= russia, aes(x=long,y=lat, map_id=id,group=group), fill="white", colour="black") +
  geom_count(data = results_by_year_map, aes(x = Долгота, y = Широта, color = ..n..)) +
  scale_colour_gradient(low = "#56B1F7", high = "#132B43") +
  scale_size(range=c(2,7)) +
  theme_light() +
  labs(title= "Частота снегопадов", x="Долгота", y= "Широта", color = "Число событий", size = "Число событий") +
  coord_map(projection = "azequidistant")
#сохраняем карту
ggsave("Осадки (частота).png")
#отображаем карту (можно закомментировать)
precipitation_freq_plot



#строим карту с отображением уровня осадков
precipitation_vol_plot <- ggplot() +
  geom_map(data = russia, map = russia, aes(map_id=id,group=group), fill="white", colour="black") +
  geom_point(data = arrange(results_by_year_map, Сумма_осадков), aes(x = Долгота, y = Широта, color = Сумма_осадков), size = 3) +
  #scale_color_hue(direction = -1) +
  scale_colour_gradient(low = "#56B1F7", high = "#132B43") +
  #scale_colour_gradient(low = "#deebf7", high = "#3182bd") +
  #scale_color_brewer(palette = "Blues") +
  scale_size(range=c(2,7)) +
  theme_light() +
  labs(title= "Максимум осадков за 12 часов", x="Долгота", y= "Широта", color = "Осадки (мм)") +
  coord_map(projection = "azequidistant")
#сохраняем карту
ggsave("Осадки (объем).png")
#отображаем карту (можно закомментировать)
precipitation_vol_plot



 

